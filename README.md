# Linux Exploit Development Environment

## Building

Tested on Ubuntu 22.04.

```bash
sudo apt update
sudo apt install -y bc bison build-essential flex git libelf-dev libssl-dev ncurses-dev qemu qemu-system-x86 llvm clang clang-tools lld lz4 binutils-aarch64-linux-gnu gcc-aarch64-linux-gnu
git clone --recursive https://github.com/gsingh93/linux-exploit-dev-env
cd linux-exploit-dev-env
```

This will clone the Linux kernel and Android Common Kernel (ACK) submodules. You can checkout any version of the kernel you want, i.e.
```bash
cd linux
git checkout v5.10.107    # Checkout a specific version
git checkout linux-5.10.y # Checkout the latest version of an LTS kernel
```

To see all targets and configuration options:

```bash
$ make help
Environment Variables:
   ARCH                          - Specify one of the supported architectures: x86_64, arm64 (default: x86_64)
   ACK                           - Set to 1 if building ACK instead of the Linux kernel. Does not need to be set for `ack` and `run-ack` targets (default: 0)
   GDB                           - Set to 1 to start a gdbserver and wait for GDB when running QEMU (default: 0)
   CPU                           - Specify the number of CPUs to use when running QEMU (default: 4)
   MEM                           - Specify the memory size in MB to use when running QEMU (default: 1024)
   QEMU_EXTRA_ARGS               - Specify additional arguments to pass to QEMU (default: "")
   QEMU_EXTRA_KERNEL_CMDLINE     - Specify additional arguments to pass to the kernel (default: "")
   VERBOSE                       - Set to 1 to enable verbose output (default: 0)
   EXT4_SIZE                     - TODO
   INITRAMFS_DIR                 - TODO
   ROOTFS                        - TODO
   ROOTFS_FORMAT                 - TODO
   INITRD                        - TODO
   RDINIT                        - TODO
   LINUX_DEFCONFIG               - TODO
   LINUX_SRC                     - TODO
   LINUX_OUT                     - TODO
   KERNEL_IMAGE                  - TODO
   LINUX_CONFIG_FRAGMENT         - TODO
   VERSION                       - TODO

Build/Config Targets:
   linux (default)               - builds the Linux kernel
   linux_defconfig               - builds the Linux kernel
   linux_modules                 - builds the Linux kernel modules
   ack                           - builds the Android Common Kernel
   tools-vm                      - builds linux/tools/vm

Clean Targets:
   clean                         - cleans output from all build targets
   <target>_clean                - cleans output for <target>

Run/Debug Targets:
   run                           - run QEMU with the built kernel, bootloader, and rootfs image
   run-ack                       - same as `run` but runs ACK instead

rootfs Targets:
   rootfs-init                   - TODO
   rootfs                        - TODO
   ext4                          - TODO
   cpio                          - TODO
   rootfs-mount                  - TODO
   rootfs-unmount                - TODO

Miscellaneous:
   linux_download                - TODO
   linux_checkout                - TODO
```

To build the Linux kernel:
```bash
make # or: make linux
```

To build an `arm64` kernel instead of the default of `x86_64`:
```bash
ARCH=arm64 make
```

To build ACK instead of Linux:
```bash
ACK=1 make linux       # or: make ack
ACK=1 ARCH=arm64 linux # or: ARCH=arm64 make ack
```

All built artifacts are placed in `out/`. ACK and Linux builds are placed in separate folders, and each architecture is placed in their own folders, so you can switch between these kernels without the other build variants.

The default build targets can be cleaned with `make clean`, and any specific target can be cleaned with `make <target>_clean`, i.e.:
```bash
make linux_clean
```

## Running

First setup the default Alpine rootfs:
```bash
make rootfs-init            # x86_64 rootfs
ARCH=arm64 make rootfs-init # arm64 rootfs
```

To run the built `x86_64` Linux image with QEMU:
```bash
make run
```

The other variants can be run by setting the same environment variables that were needed to build them:
```bash
ACK=1 make run
ARCH=arm64 make run
ACK=1 ARCH=arm64 make run
```

To start a GDB server and wait for GDB to attach, set the `GDB` environment variable:
```bash
GDB=1 make run
```

To exit QEMU, use `ctrl+a x` (`ctrl-c` will not work).

## Configuration

TODO
