#!/bin/sh

case "$1" in
    start)
        # If the user already exists this won't cause any problems
        adduser user --disabled-password 2>/dev/null

        mkdir -p /shared
        mount -t 9p -o trans=virtio,version=9p2000.L shared /shared

        mount -t debugfs none /sys/kernel/debug
        [ ! -e /d ] && ln -s /sys/kernel/debug /d

        mount -t tracefs nodev /sys/kernel/tracing
        [ ! -e /t ] && ln -s /sys/kernel/tracing /t

        # Only mount binder if the kernel supports it
        cat /proc/filesystems | grep binder > /dev/null
        if [[ $? -eq 0 ]]; then
            mkdir -p /dev/binderfs
            mount -t binder binder /dev/binderfs
            ln -s /dev/binderfs/binder /dev/binder
            echo 16383 > /sys/module/binder/parameters/debug_mask
        fi

        [ -x /shared/init.sh ] && /shared/init.sh
        ;;
    *) ;;
esac

exit 0
